---
import Layout from '../layouts/Layout.astro';
import { Header } from '../components/Header';
import { VideoPlayer } from '../components/VideoPlayer';
import { LessonList } from '../components/LessonList';
import { ResourceBox } from '../components/ResourceBox';
import { CompletionButton } from '../components/CompletionButton';
import { FloatingMenu } from '../components/FloatingMenu';

// Configuración de la API
const API_URL = 'https://godotapi.rsanjur.com';
const userId = "1"; // TODO: Obtener de la sesión real

// Obtener la lección activa desde la URL (?lesson=ID)
const url = new URL(Astro.request.url);
const activeLessonId = url.searchParams.get('lesson');

// Fetch dinámico de datos desde el backend externo
let lessons = [];
let userProgress = [];
let error = null;

try {
  const response = await fetch(`${API_URL}/api/course/${userId}`);
  if (response.ok) {
    const data = await response.json();
    lessons = data.lessons;
    userProgress = data.progress;
    
    // Mapear el progreso a las lecciones y formatear para el componente
    lessons = lessons.map(lesson => ({
      ...lesson,
      duration: "5:00", // La DB no tiene duración, hardcodeamos o calculamos
      completed: userProgress.some(p => p.lessonId === lesson.id && p.completed)
    }));
  } else {
    error = "Error al cargar los datos del curso";
  }
} catch (e) {
  error = "No se pudo conectar con el servidor";
}

// Determinar lección activa (por URL o la primera no completada)
const activeLesson = lessons.find(l => l.id.toString() === activeLessonId) 
                 || lessons.find(l => !l.completed) 
                 || lessons[0];

const progress = lessons.length > 0 
  ? Math.round((lessons.filter(l => l.completed).length / lessons.length) * 100)
  : 0;
const level = Math.floor(progress / 10) + 1;

// Descripción dinámica (podría venir de la API en el futuro)
const description = `En esta lección titulada "${activeLesson?.title || 'Cargando...'}", profundizaremos en los conceptos clave de Godot 4.6 para mejorar tu flujo de trabajo.`;
---

<Layout title={activeLesson?.title || "Dashboard"}>
	<Header 
		client:load 
		progress={progress} 
		level={level} 
		username="Ricardo" 
		userEmail="ricardosanjurg@gmail.com"
	/>

	{error ? (
		<div class="flex-1 flex flex-col items-center justify-center p-6">
			<div class="glass p-8 rounded-2xl border border-red-500/20 text-center max-w-md">
				<h2 class="text-xl font-bold text-red-500 mb-2">¡Ups! Algo salió mal</h2>
				<p class="text-white/60 mb-6">{error}</p>
				<button onclick="window.location.reload()" class="bg-white/10 hover:bg-white/20 px-6 py-2 rounded-lg transition-all">
					Reintentar
				</button>
			</div>
		</div>
	) : (
		<main class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6 p-6 max-w-[1600px] mx-auto w-full">
			<!-- Left Column: Video & Resources -->
			<div class="lg:col-span-8 flex flex-col gap-6">
				<div class="space-y-4">
					<VideoPlayer 
						client:load 
						videoUrl={activeLesson?.videoUrl || "#"} 
						thumbnail="https://images.unsplash.com/photo-1550745165-9bc0b252726f?q=80&w=1200&auto=format&fit=crop" 
					/>
					
					<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
						<div>
							<h1 class="text-2xl font-bold text-white">{activeLesson?.title}</h1>
							<p class="text-white/50 text-sm mt-1">Módulo: Desarrollo con Godot 4.6</p>
						</div>
						<CompletionButton 
							client:load 
							lessonId={activeLesson?.id?.toString()} 
							userId={userId} 
							isCompleted={activeLesson?.completed || false} 
						/>
					</div>
				</div>

				<ResourceBox 
					client:load 
					description={description}
					code={`# Código para la lección: ${activeLesson?.title}\n# Implementación en Godot 4.6\n\nextends Node\n\nfunc _ready():\n    print("¡Listo para aprender!")`}
					downloadUrl="#"
				/>
			</div>

			<!-- Right Column: Lesson List -->
			<div class="lg:col-span-4 h-[calc(100vh-140px)] sticky top-[100px]">
				<div class="h-full">
					<LessonList 
						client:load 
						lessons={lessons} 
						activeLessonId={activeLesson?.id?.toString()}
						onLessonSelect={(lesson) => {
							window.location.search = `?lesson=${lesson.id}`;
						}} 
					/>
				</div>
			</div>
		</main>
	)}

	<FloatingMenu client:load />
</Layout>
